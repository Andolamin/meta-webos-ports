From 50f43a0c56e4329facbba6b7e4bbec0e87ff9d63 Mon Sep 17 00:00:00 2001
From: Giulio Camuffo <giulio.camuffo@jollamobile.com>
Date: Tue, 4 Feb 2014 11:28:31 +0200
Subject: [PATCH] Fix the client behavior when showing or hiding a surface
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reduce the chances of seeing a bad frame.

Change-Id: Idac3450d92210fc5fc33cb68862b089964c9a8ce
Reviewed-by: JÃ¸rgen Lind <jorgen.lind@digia.com>
---
 src/client/qwaylandwindow.cpp |    7 ++-----
 1 files changed, 2 insertions(+), 5 deletions(-)

diff --git a/src/client/qwaylandwindow.cpp b/src/client/qwaylandwindow.cpp
index 67f122f..920c977 100644
--- a/src/client/qwaylandwindow.cpp
+++ b/src/client/qwaylandwindow.cpp
@@ -207,9 +207,6 @@ void QWaylandWindow::setGeometry(const QRect &rect)
 void QWaylandWindow::setVisible(bool visible)
 {
     if (visible) {
-        if (mBuffer)
-            attach(mBuffer->buffer(), 0, 0);
-
         if (window()->type() == Qt::Popup && transientParent()) {
             QWaylandWindow *parent = transientParent();
             mMouseDevice = parent->mMouseDevice;
@@ -230,10 +227,10 @@ void QWaylandWindow::setVisible(bool visible)
         // QWaylandShmBackingStore::beginPaint().
     } else {
         QWindowSystemInterface::handleExposeEvent(window(), QRegion());
+        QWindowSystemInterface::flushWindowSystemEvents();
         attach(static_cast<QWaylandBuffer *>(0), 0, 0);
+        commit();
     }
-    damage(QRect(QPoint(0,0),geometry().size()));
-    commit();
 }
 
 
-- 
1.7.1

