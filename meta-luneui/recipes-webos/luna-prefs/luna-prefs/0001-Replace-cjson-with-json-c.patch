From 9cea219fc9f6bf4ec377fc317cf220fc903cb015 Mon Sep 17 00:00:00 2001
From: Martin Jansa <martin.jansa@lge.com>
Date: Fri, 12 Dec 2014 01:14:45 +0100
Subject: [PATCH 1/2] Replace cjson with json-c

Signed-off-by: Martin Jansa <martin.jansa@lge.com>
---
 README.md                         |  2 +-
 include/lunaprefs.h               |  2 +-
 libluna-prefs/CMakeLists.txt      | 22 +++-------------------
 libluna-prefs/lunaprefs.c         |  2 +-
 luna-prefs-service/CMakeLists.txt |  9 +++------
 luna-prefs-service/Makefile       |  2 +-
 luna-prefs-service/main.c         |  2 +-
 luna-prop/CMakeLists.txt          | 22 +++-------------------
 luna-prop/Makefile                |  2 +-
 luna-prop/main.c                  |  2 +-
 10 files changed, 16 insertions(+), 51 deletions(-)

diff --git a/README.md b/README.md
index c84f208..a00f88d 100644
--- a/README.md
+++ b/README.md
@@ -104,7 +104,7 @@ Below are the tools and libraries (and their minimum versions) required to build
 * openwebos/cmake-modules-webos 1.0.0 RC2
 * cmake (version required by openwebos/cmake-modules-webos)
 * openwebos/luna-service2 3.0.0
-* openwebos/cjson 1.8.0
+* json-c 0.11
 * sqlite3 3.7.4-2
 * glib-2.0 2.28.6
 
diff --git a/include/lunaprefs.h b/include/lunaprefs.h
index 29490b8..41e2700 100644
--- a/include/lunaprefs.h
+++ b/include/lunaprefs.h
@@ -26,7 +26,7 @@
 #ifdef USE_MJSON
 #include <json.h>
 #endif
-#include <cjson/json.h>
+#include <json.h>
 
 #ifdef __cplusplus
 extern "C" {
diff --git a/libluna-prefs/CMakeLists.txt b/libluna-prefs/CMakeLists.txt
index cad1d80..b8711c0 100644
--- a/libluna-prefs/CMakeLists.txt
+++ b/libluna-prefs/CMakeLists.txt
@@ -42,25 +42,9 @@ include_directories(../include/)
 pkg_check_modules(GLIB2 REQUIRED glib-2.0)
 webos_add_compiler_flags(ALL ${GLIB2_CFLAGS})
 
-# -- check for cjson
-pkg_check_modules(CJSON REQUIRED cjson)
-webos_add_compiler_flags(ALL ${CJSON_CFLAGS})
-
-# commented: see note below
-#include_directories(${CJSON_INCLUDE_DIRS}/cjson)
-
-# -- Note that both $MJSON_INCLUDE_DIRS and 
-# $CJSON_INCLUDE_DIRS point to the same path.
-# lunaprops.h has an explicit cjson/json.h check.
- 
-# /usr/local/include/json.h --> from mjson
-# /usr/local/include/cjson/json.h --> from cjson
-
-# Given this, the best solution is to _NOT_ include the cjson
-# include path. The confusion arises since mjson supplies
-# a json.h which is different from cjson/json.h, and CMAKE
-# is not able to figure out the proper json.h to be used,
-# always overriding mjson's json.h
+# -- check for json
+pkg_check_modules(JSON REQUIRED json-c)
+webos_add_compiler_flags(ALL ${JSON_CFLAGS})
 
 # -- check for sqlite 3.0
 pkg_check_modules(SQLITE3 REQUIRED sqlite3)
diff --git a/libluna-prefs/lunaprefs.c b/libluna-prefs/lunaprefs.c
index c148fc0..2f799d4 100644
--- a/libluna-prefs/lunaprefs.c
+++ b/libluna-prefs/lunaprefs.c
@@ -35,7 +35,7 @@
 #ifdef USE_MJSON
 #include <json.h>
 #endif
-#include <cjson/json.h>
+#include <json.h>
 #include <nyx/nyx_client.h>
 /* todo:
  *
diff --git a/luna-prefs-service/CMakeLists.txt b/luna-prefs-service/CMakeLists.txt
index 8f1e190..ece8f10 100644
--- a/luna-prefs-service/CMakeLists.txt
+++ b/luna-prefs-service/CMakeLists.txt
@@ -40,12 +40,9 @@ include_directories(../include/)
 pkg_check_modules(GLIB2 REQUIRED glib-2.0)
 webos_add_compiler_flags(ALL ${GLIB2_CFLAGS})
 
-# -- check for cjson
-pkg_check_modules(CJSON REQUIRED cjson)
-webos_add_compiler_flags(ALL ${CJSON_CFLAGS})
-
-# commented to get correct json.h files
-#include_directories(${CJSON_INCLUDE_DIRS}/cjson)
+# -- check for json-c
+pkg_check_modules(JSON REQUIRED json-c)
+webos_add_compiler_flags(ALL ${JSON_CFLAGS})
 
 # -- check for LS2 (internally depends on pmloglib)
 pkg_check_modules(LS2 REQUIRED luna-service2)
diff --git a/luna-prefs-service/Makefile b/luna-prefs-service/Makefile
index c5b57ac..3b9874b 100644
--- a/luna-prefs-service/Makefile
+++ b/luna-prefs-service/Makefile
@@ -19,7 +19,7 @@
 TOP ?= ..
 include $(TOP)/config.mk
 
-LIBS=glib-2.0 lunaservice luna-prefs cjson
+LIBS=glib-2.0 lunaservice luna-prefs json
 
 OBJDIR=objs
 
diff --git a/luna-prefs-service/main.c b/luna-prefs-service/main.c
index d915b29..2d1e79b 100644
--- a/luna-prefs-service/main.c
+++ b/luna-prefs-service/main.c
@@ -30,7 +30,7 @@
 
 #include <luna-service2/lunaservice.h>
 #include <lunaprefs.h>
-#include <cjson/json.h>
+#include <json.h>
 
 // #define DROP_DEPRECATED         /* Define to disable the older, deprecated method names */
 
diff --git a/luna-prop/CMakeLists.txt b/luna-prop/CMakeLists.txt
index 0932744..6026867 100644
--- a/luna-prop/CMakeLists.txt
+++ b/luna-prop/CMakeLists.txt
@@ -40,25 +40,9 @@ include_directories(../include/)
 pkg_check_modules(GLIB2 REQUIRED glib-2.0)
 webos_add_compiler_flags(ALL ${GLIB2_CFLAGS})
 
-# -- check for cjson
-pkg_check_modules(CJSON REQUIRED cjson)
-webos_add_compiler_flags(ALL ${CJSON_CFLAGS})
-
-# commented: see note below
-#include_directories(${CJSON_INCLUDE_DIRS}/cjson)
-
-# -- Note that both $MJSON_INCLUDE_DIRS and 
-# $CJSON_INCLUDE_DIRS point to the same path.
-# lunaprops.h has an explicit cjson/json.h check.
- 
-# /usr/local/include/json.h --> from mjson
-# /usr/local/include/cjson/json.h --> from cjson
-
-# Given this, the best solution is to _NOT_ include the cjson
-# include path. The confusion arises since mjson supplies
-# a json.h which is different from cjson/json.h, and CMAKE
-# is not able to figure out the proper json.h to be used,
-# always overriding mjson's json.h
+# -- check for json-c
+pkg_check_modules(JSON REQUIRED json-c)
+webos_add_compiler_flags(ALL ${JSON_CFLAGS})
 
 # -- no way to disable warn_unused_result right now.
 webos_add_compiler_flags(ALL -g -O3 -Wall -Wno-unused-but-set-variable -Wno-unused-variable -fno-exceptions)
diff --git a/luna-prop/Makefile b/luna-prop/Makefile
index 8846a08..44b94a5 100644
--- a/luna-prop/Makefile
+++ b/luna-prop/Makefile
@@ -19,7 +19,7 @@
 TOP ?= ..
 include $(TOP)/config.mk
 
-LIBS=glib-2.0 lunaservice luna-prefs cjson
+LIBS=glib-2.0 lunaservice luna-prefs json
 
 OBJDIR=objs
 
diff --git a/luna-prop/main.c b/luna-prop/main.c
index 02886ad..9492b00 100644
--- a/luna-prop/main.c
+++ b/luna-prop/main.c
@@ -25,7 +25,7 @@
 #include <glib.h>
 #include <unistd.h>
 #include <stdarg.h>
-#include <cjson/json.h>
+#include <json.h>
 #include <getopt.h>
 
 #include "lunaprefs.h"
-- 
2.2.0

