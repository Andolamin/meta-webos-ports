From cc9b82023b0892ffee9275df1029008fd77e135c Mon Sep 17 00:00:00 2001
From: Ricardo Salveti de Araujo <ricardo.salveti@canonical.com>
Date: Tue, 6 Aug 2013 04:14:45 -0300
Subject: [PATCH 2/2] properties.c: track if we have a patched init for a
 better ret value

Signed-off-by: Ricardo Salveti de Araujo <ricardo.salveti@canonical.com>
---
 hybris/properties/properties.c | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/hybris/properties/properties.c b/hybris/properties/properties.c
index cc350e2..195aecb 100644
--- a/hybris/properties/properties.c
+++ b/hybris/properties/properties.c
@@ -139,6 +139,7 @@ static int send_prop_msg(prop_msg_t *msg,
 	int s;
 	int r;
 	int result = -1;
+	int patched_init = 0;
 
 	s = socket(AF_LOCAL, SOCK_STREAM, 0);
 	if (s < 0) {
@@ -171,12 +172,19 @@ static int send_prop_msg(prop_msg_t *msg,
 				return result;
 			}
 
+			/* If we got a reply, this is a patched init */
+			if (!patched_init)
+				patched_init = 1;
+
 			if (propfn)
 				propfn(msg->name, msg->value, cookie);
 		}
 
-		if (r >= 0)
+		/* We also just get a close in case of setprop */
+		if ((r >= 0) && (patched_init ||
+				(msg->cmd == PROP_MSG_SETPROP))) {
 			result = 0;
+		}
 	}
 
 	close(s);
-- 
1.8.1.2

